import streamlit as st
from PIL import Image, ImageEnhance
import io
import rembg
import cv2
import numpy as np

st.set_page_config(page_title="RemixMyDesign AI", layout="centered")
st.title("ğŸ¨ RemixMyDesign - AI pour Designers")

st.markdown("""
TÃ©lÃ©verse un design, choisis le niveau de remix, et reÃ§ois une nouvelle version en PNG avec fond transparent et qualitÃ© amÃ©liorÃ©e.
""")

uploaded_file = st.file_uploader("ğŸ“¤ TÃ©lÃ©verse ton design (PNG ou JPG)", type=["png", "jpg", "jpeg"])
remix_level = st.slider("ğŸšï¸ Pourcentage de remix", 10, 100, 30, step=10)

if uploaded_file and st.button("ğŸš€ GÃ©nÃ©rer Remix"):
    st.info("ğŸ”„ Remix et amÃ©lioration de ton design en coursâ€¦")

    # Charger l'image d'origine
    image = Image.open(uploaded_file).convert("RGBA")

    # Supprimer l'arriÃ¨re-plan avec rembg
    input_bytes = io.BytesIO()
    image.save(input_bytes, format="PNG")
    input_bytes = input_bytes.getvalue()
    output_bytes = rembg.remove(input_bytes)
    transparent_image = Image.open(io.BytesIO(output_bytes)).convert("RGBA")

    # Appliquer un effet de remix simple en fonction du niveau choisi
    enhancer = ImageEnhance.Contrast(transparent_image)
    remixed_image = enhancer.enhance(1 + remix_level / 100)

    # Upscale de lâ€™image en 2x avec OpenCV
    remixed_np = np.array(remixed_image)
    upscaled_np = cv2.resize(remixed_np, (remixed_np.shape[1]*2, remixed_np.shape[0]*2), interpolation=cv2.INTER_CUBIC)
    upscaled_image = Image.fromarray(upscaled_np)

    # Affichage du rÃ©sultat
    st.image(upscaled_image, caption=f"Remix Ã  {remix_level}% (HD)", use_container_width=True)

    # TÃ©lÃ©chargement de l'image finale
    buf = io.BytesIO()
    upscaled_image.save(buf, format="PNG")
    byte_im = buf.getvalue()
    st.download_button(
        label="ğŸ“¥ TÃ©lÃ©charger l'image remixÃ©e (HD)",
        data=byte_im,
        file_name=f"remix_{remix_level}_percent_hd.png",
        mime="image/png"
    )
else:
    st.warning("ğŸ–¼ï¸ TÃ©lÃ©verse une image pour commencer.")